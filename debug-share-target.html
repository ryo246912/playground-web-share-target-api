<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Target ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
        }
        button:hover { background: #1565c0; }
        .test-result {
            font-family: monospace;
            background: #2d2d2d;
            color: #f5f5f5;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Share Target ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="debug-section warning">
        <h3>âš ï¸ ç¾åœ¨ã®å•é¡Œ</h3>
        <p>å…±æœ‰æ©Ÿèƒ½ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã§åŸå› ã‚’ç‰¹å®šã§ãã¾ã™ã€‚</p>
    </div>

    <div class="debug-section">
        <h3>ğŸ“‹ ç¾åœ¨ã®è¨­å®šæƒ…å ±</h3>
        <div id="config-info">è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="debug-section">
        <h3>ğŸ§ª Share Target URLãƒ†ã‚¹ãƒˆ</h3>
        <p>å…±æœ‰æ©Ÿèƒ½ãŒå®Ÿéš›ã«å‘¼ã³å‡ºã™URLã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ï¼š</p>
        <div>
            <input type="url" id="test-url" placeholder="ãƒ†ã‚¹ãƒˆç”¨URL (ä¾‹: https://youtube.com/watch?v=123)" value="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
            <input type="text" id="test-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ãƒ†ã‚¹ãƒˆå‹•ç”»)" value="ãƒ†ã‚¹ãƒˆå‹•ç”»">
            <input type="text" id="test-text" placeholder="ãƒ†ã‚­ã‚¹ãƒˆ (ä¾‹: å…±æœ‰ãƒ†ã‚¹ãƒˆ)" value="å…±æœ‰ãƒ†ã‚¹ãƒˆ">
        </div>
        <button onclick="testShareTarget()">ğŸš€ Share Target URLã‚’ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="simulateShare()">ğŸ“± å…±æœ‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
    </div>

    <div class="debug-section">
        <h3>ğŸ”§ Service Worker è¨ºæ–­</h3>
        <button onclick="checkServiceWorker()">Service WorkerçŠ¶æ…‹ç¢ºèª</button>
        <button onclick="clearServiceWorker()">Service Worker ãƒªã‚»ãƒƒãƒˆ</button>
        <button onclick="testFetch()">Fetchå‹•ä½œãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div class="debug-section">
        <h3>ğŸ“„ Manifest.json è¨ºæ–­</h3>
        <button onclick="checkManifest()">Manifestè¨­å®šç¢ºèª</button>
        <button onclick="validateShareTarget()">Share Targetè¨­å®šæ¤œè¨¼</button>
    </div>

    <div class="debug-section">
        <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h3>
        <div id="test-results" class="test-result">ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
    </div>

    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            const logMessage = `[${timestamp}] ${prefix} ${message}`;
            testResults.push(logMessage);
            updateTestResults();
            console.log(logMessage);
        }

        function updateTestResults() {
            document.getElementById('test-results').textContent = testResults.join('\n');
        }

        async function loadConfigInfo() {
            try {
                const response = await fetch('./manifest.json');
                const manifest = await response.json();
                
                const configDiv = document.getElementById('config-info');
                configDiv.innerHTML = `
                    <p><strong>ã‚¢ãƒ—ãƒªå:</strong> ${manifest.name}</p>
                    <p><strong>Start URL:</strong> ${manifest.start_url}</p>
                    <p><strong>Scope:</strong> ${manifest.scope}</p>
                    <p><strong>Share Target Action:</strong> ${manifest.share_target.action}</p>
                    <p><strong>ç¾åœ¨ã®URL:</strong> ${location.href}</p>
                    <p><strong>Origin:</strong> ${location.origin}</p>
                `;
                log(`Manifestèª­ã¿è¾¼ã¿æˆåŠŸ: ${manifest.name}`, 'success');
            } catch (error) {
                log(`Manifestèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testShareTarget() {
            const url = document.getElementById('test-url').value;
            const title = document.getElementById('test-title').value;
            const text = document.getElementById('test-text').value;

            if (!url) {
                log('ãƒ†ã‚¹ãƒˆç”¨URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            try {
                const response = await fetch('./manifest.json');
                const manifest = await response.json();
                
                const shareTargetUrl = new URL(manifest.share_target.action, location.origin);
                shareTargetUrl.searchParams.set('url', url);
                shareTargetUrl.searchParams.set('title', title);
                shareTargetUrl.searchParams.set('text', text);

                log(`ç”Ÿæˆã•ã‚ŒãŸShare Target URL: ${shareTargetUrl.toString()}`, 'info');
                
                // å®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹
                const testResponse = await fetch(shareTargetUrl.toString());
                if (testResponse.ok) {
                    log(`Share Target URLã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ (${testResponse.status})`, 'success');
                } else {
                    log(`Share Target URLã‚¢ã‚¯ã‚»ã‚¹å¤±æ•— (${testResponse.status})`, 'error');
                }
                
            } catch (error) {
                log(`Share Target URLãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function simulateShare() {
            const url = document.getElementById('test-url').value;
            const title = document.getElementById('test-title').value;
            const text = document.getElementById('test-text').value;

            const shareTargetUrl = `${location.origin}/playground-web-share-target-api/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&text=${encodeURIComponent(text)}`;
            
            log(`å…±æœ‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ URL: ${shareTargetUrl}`, 'info');
            window.open(shareTargetUrl, '_blank');
        }

        async function checkServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                log('Service WorkerãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    log(`Service Workerç™»éŒ²æ¸ˆã¿ - Scope: ${registration.scope}`, 'success');
                    log(`Active WorkerçŠ¶æ…‹: ${registration.active?.state || 'ãªã—'}`, 'info');
                    
                    if (registration.waiting) {
                        log('æ–°ã—ã„Service WorkerãŒå¾…æ©Ÿä¸­ã§ã™', 'warning');
                    }
                } else {
                    log('Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`Service Workerç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function clearServiceWorker() {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                    log(`Service Workerç™»éŒ²è§£é™¤: ${registration.scope}`, 'success');
                }
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ã‚¯ãƒªã‚¢
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤: ${cacheName}`, 'success');
                }
                
                log('ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„', 'warning');
            } catch (error) {
                log(`Service Workerãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testFetch() {
            const testUrl = `${location.origin}/playground-web-share-target-api/?url=https://example.com&title=fetchtest`;
            
            try {
                log(`Fetchãƒ†ã‚¹ãƒˆé–‹å§‹: ${testUrl}`, 'info');
                const response = await fetch(testUrl);
                log(`Fetchãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const text = await response.text();
                log(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹: ${text.substring(0, 100)}...`, 'info');
                
            } catch (error) {
                log(`Fetchãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function checkManifest() {
            try {
                const response = await fetch('./manifest.json');
                const manifest = await response.json();
                
                log(`Manifestå–å¾—æˆåŠŸ`, 'success');
                log(`Share Targetè¨­å®š: ${JSON.stringify(manifest.share_target, null, 2)}`, 'info');
                
                // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
                const required = ['action', 'method', 'params'];
                const missing = required.filter(field => !manifest.share_target[field]);
                
                if (missing.length === 0) {
                    log('Share Targetè¨­å®šã¯å®Œå…¨ã§ã™', 'success');
                } else {
                    log(`ä¸è¶³ã—ã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ${missing.join(', ')}`, 'error');
                }
                
            } catch (error) {
                log(`Manifestç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function validateShareTarget() {
            const currentUrl = new URL(location.href);
            const hasShareParams = currentUrl.searchParams.has('url') || 
                                  currentUrl.searchParams.has('title') || 
                                  currentUrl.searchParams.has('text');
                                  
            if (hasShareParams) {
                log('ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã¯å…±æœ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã„ã¾ã™', 'success');
                log(`URL: ${currentUrl.searchParams.get('url') || 'ãªã—'}`, 'info');
                log(`Title: ${currentUrl.searchParams.get('title') || 'ãªã—'}`, 'info');
                log(`Text: ${currentUrl.searchParams.get('text') || 'ãªã—'}`, 'info');
            } else {
                log('å…±æœ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigInfo();
            validateShareTarget();
            log('ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†', 'success');
        });
    </script>
</body>
</html>